Ch 2: Understanding High Availability and Disaster Recovery Technologies
***************************************************************************

SQL Server provides a full suite of technologies for implementing high availability and disaster recovery. 

AlwaysOn Failover Clustering
================================

---------------------------------------------------------------------------------------------------------
--------------------------------- 2 Node cluster configurations ---------------------------------------
---------------------------------------------------------------------------------------------------------

Active-Passive Configuration (2 Node cluster)
...............................
Two-Node Cluster (Active/Passive Configuration) : https://drive.google.com/file/d/1IDgXcutPmkLe_wVvHZxI-1lGIWFmYKaP/view?usp=drive_link

- A Windows cluster is a high availability Technology in which a group of up to 64 servers works together to provide redundancy.
- An AlwaysOn Failover Clustered Instance (FCI) is an instance of SQL Server that spans the servers within this group. If one of the servers within this group fails, another server takes ownership of the instance.
- Each server within a cluster is called a node.
- Each node within the cluster also shares the same storage for the SQL Server data and log files. (The storage, however, is only attached to the active node.)
- Each node has SQL server binaries installed seperately.
- If the active node fails, then the SQL Server service is stopped and the storage is detached. The storage is then reattached to one of the other nodes in the cluster, and the SQL Server service is started on this node, which is now the active node.


Active-Active Configuration (Load-Balancing)
.................................................
Two-Node Cluster (Active/Active Configuration)  : https://drive.google.com/file/d/1cgRCL7EkOZ-H_Mj0hfQeiyzdio_AqsTr/view?usp=drive_link

- it is possible to install multiple instances on a cluster, and a different node may own each instance.
- Therefore in the above picture , in an active/active configuration, during normal operations, Node1 may host Instance1 and Node2 may host Instance2. If Node1 fails, both instances are then hosted by Node2, and vice-versa. 
- Caution  
>>>>>>>>>
In an active/active cluster, it is important to consider resources in the event of failover. 
For example, if each node in a cluster group has 128GB of RAM and the instance hosted on each node is configured to use 96GB of RAM and locking pages in memory, then when one node fails over to the other node, this node fails as well, because it does not have enough memory to allocate to both instances. Make sure you plan both memory and processor requirements as if the two nodes are a single server. For this reason, active/active clusters are not generally recommended for SQL Server.

---------------------------------------------------------------------------------------------------------
----------------------------- 3-Plus Node Configurations -----------------------------------
---------------------------------------------------------------------------------------------------------

When you have 3 or more nodes, it is unlikely that you will want to have a single active node and two redundant nodes, due to the associated costs. Instead, you can choose to implement an N+1 or N+M configuration.
In an N+1 configuration, you have multiple active nodes and a single passive node. If a failure occurs on any of the active nodes, they fail over to the passive node.

The diagram below depicts a three-node N+1 cluster (where N: No of Active Nodes, 1: only 1 Passive Node. any failure in active node, will result in failover to passive node, provided the passive node has enough resources to handle workloads)
https://drive.google.com/file/d/1m-RqZhtxG8L85gA1PwS1nldQO50N5FyS/view?usp=sharing

The diagram below depicts a three-node N+M cluster. (where N: No of Active Nodes, M: Many Passive Nodes. The diagram shows that Instance3 is configured to always fail over to one of the passive nodes, whereas Instance1 and Instance2 are configured to always fail over to the other passive node. we can also configure the cluster to allow any of the active nodes to fail over to either of the passive nodes )
https://drive.google.com/file/d/152zq4TVMvyRkjamC_42jdyyvMiNp-fmo/view?usp=sharing


Quorum
---------
- The definition of a quorum is “The minimum number of members required in order for business to be carried out.” 
- In terms of high availability, this means that each node within a cluster, and optionally a witness device (which may be a cluster disk or a file share that is external to the cluster), receives a vote.
    -- Split-brain scenario:
       --------------------
       imagine that you have 
        > 3 nodes in Data Center 1 and 
        > 3 nodes in Data Center 2
       Imagine that you lose network connectivity between the two data centers, yet all six nodes remain online.
       Now, The 3 nodes in Data Center 1 believe that all of the nodes in Data Center 2 are unavailable. Conversely, the 3 nodes in Data Center 2 believe that the nodes in Data Center 1 are unavailable.
       This leaves both sides (known as partitions) of the cluster thinking that they should take control. 
       This can have unpredictable and undesirable consequences for any application that successfully connects to one or the other partition.
       The Quorum = (Voting Members / 2) + 1 formula protects against this scenario.
Note/Tip: 
---------
- Tip : If your cluster loses quorum, then you can force one partition online, by starting the cluster service using the /fq switch. 
- If you are using Windows Server 2012 R2 or higher, then the partition that you force online is considered the authoritative partition. This means that other partitions can automatically re-join the cluster when connectivity is re-established.

- Quorum Models
================
there are many Quorum Models (that suits as per requirement)

Quorum Model                                   Appropriate Usage
---------------------------------------------------------------------------------------------------------
Node Majority                                          When you have an odd number of nodes in the cluster
Node + Disk Witness Majority                           When you have an even number of nodes in the cluster
Node + File Share Witness Majority                     When you have nodes split across multiple sites or when you have an even number of nodes and are required to avoid shared disks*

Note: 
-------
- Windows Server 2012 R2 also introduces the concepts of Dynamic Quorum and Tie Breaker for 50% Node Split.
- When Dynamic Quorum is enabled, the cluster service automatically decides whether or not to give the quorum witness a vote, depending on the number of nodes in the cluster.
- If you have an even number of nodes, only then it is assigned a vote. 
- For Tie Breaker for 50% Node Split,  If you have an even number of nodes and a witness and the witness fails, then the cluster service automatically removes a vote from one random node within the cluster. This   
  maintains an odd number of votes in the quorum and reduces the risk of a cluster going offline, due to a witness failure.

Database Mirroring
========================================
- Database mirroring is a technology that can provide configurations for both high availability and disaster recovery. 
- implemented entirely within SQL Server and provides availability at the database level
- It works by compressing transaction log records and sending them to the secondary server via a TCP endpoint.
- A database mirroring topology consists of precisely one 
    1. primary server, 
    2. precisely one secondary server, and 
    3. an optional witness server.
- Database mirroring can be configured to run in 3 different modes: 
    1. High Performance                    : database not in Sync / async manor
    2. High Safety                         : database in sync state on primary & secondary server.
    3. High Safety with Automatic Failover : database mirroring topology needs to form a quorum. In order to achieve quorum, it needs a third server. This server is known as the witness server

- Database mirroring in high Performance Mode                       : https://drive.google.com/file/d/1zwD2pMEDn5N8v9K5oDToYRMy20j-zBaM/view?usp=sharing
- Database mirroring in High Safety with Automatic Failover mode    : https://drive.google.com/file/d/1xat3dn1QoOMM3UqxfTkHPbKIzW4YNafR/view?usp=sharing
- Note: 
-------
Tip  Database mirroring is not supported on databases that use In-Memory OLTP. You will be unable to configure database mirroring, if your database contains a memory-optimized filegroup.


AlwaysOn Availability Groups
*********************************
- AlwaysOn Availability Groups (AOAG) replaces database mirroring and is essentially a merger of database mirroring and clustering technologies. 
- 
- 
- 
- 


























